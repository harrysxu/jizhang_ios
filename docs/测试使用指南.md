# è®°è´¦åº”ç”¨æµ‹è¯•å¥—ä»¶

æœ¬é¡¹ç›®åŒ…å«å…¨é¢çš„å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’ŒUIæµ‹è¯•ï¼Œç¡®ä¿åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘æ­£ç¡®ã€‚

## ğŸ“Š æµ‹è¯•è¦†ç›–æ¦‚è§ˆ

- **131+** ä¸ªæµ‹è¯•ç”¨ä¾‹
- **88** ä¸ªæ•°æ®æ¨¡å‹æµ‹è¯•
- **10** ä¸ªViewModelæµ‹è¯•
- **25** ä¸ªé›†æˆæµ‹è¯•
- **8** ä¸ªUIæµç¨‹æµ‹è¯•

## ğŸ—‚ï¸ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
jizhangTests/
â”œâ”€â”€ Helpers/
â”‚   â”œâ”€â”€ TestHelpers.swift           # æµ‹è¯•æ•°æ®åˆ›å»ºè¾…åŠ©
â”‚   â””â”€â”€ MockData.swift              # æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ TransactionModelTests.swift # äº¤æ˜“æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ AccountModelTests.swift     # è´¦æˆ·æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ CategoryModelTests.swift    # åˆ†ç±»æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ BudgetModelTests.swift      # é¢„ç®—æ¨¡å‹æµ‹è¯•
â”‚   â””â”€â”€ LedgerModelTests.swift      # è´¦æœ¬æ¨¡å‹æµ‹è¯•
â”œâ”€â”€ ViewModels/
â”‚   â””â”€â”€ HomeViewModelTests.swift    # ä¸»é¡µViewModelæµ‹è¯•
â”œâ”€â”€ Integration/
â”‚   â”œâ”€â”€ LedgerIsolationTests.swift           # è´¦æœ¬éš”ç¦»æµ‹è¯•
â”‚   â”œâ”€â”€ AccountBalanceConsistencyTests.swift # ä½™é¢ä¸€è‡´æ€§æµ‹è¯•
â”‚   â””â”€â”€ BudgetTrackingTests.swift            # é¢„ç®—è¿½è¸ªæµ‹è¯•
â””â”€â”€ jizhangTests.swift

jizhangUITests/
â”œâ”€â”€ Helpers/
â”‚   â”œâ”€â”€ UITestHelpers.swift         # UIæµ‹è¯•è¾…åŠ©ç±»
â”‚   â””â”€â”€ XCUIElementExtensions.swift # UIå…ƒç´ æ‰©å±•
â”œâ”€â”€ Flows/
â”‚   â””â”€â”€ TransactionFlowUITests.swift # è®°è´¦æµç¨‹æµ‹è¯•
â””â”€â”€ jizhangUITests.swift
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### åœ¨Xcodeä¸­è¿è¡Œ

1. æ‰“å¼€é¡¹ç›®ï¼š`jizhang.xcodeproj`
2. æŒ‰ `âŒ˜+U` è¿è¡Œæ‰€æœ‰æµ‹è¯•
3. æˆ–åœ¨æµ‹è¯•å¯¼èˆªå™¨ï¼ˆ`âŒ˜+6`ï¼‰ä¸­é€‰æ‹©ç‰¹å®šæµ‹è¯•

### å‘½ä»¤è¡Œè¿è¡Œ

#### è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
```bash
xcodebuild test \
  -scheme jizhang \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  -only-testing:jizhangTests
```

#### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
```bash
# è¿è¡Œäº¤æ˜“æ¨¡å‹æµ‹è¯•
xcodebuild test \
  -scheme jizhang \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  -only-testing:jizhangTests/TransactionModelTests
```

#### è¿è¡ŒUIæµ‹è¯•
```bash
xcodebuild test \
  -scheme jizhang \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  -only-testing:jizhangUITests
```

#### ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š
```bash
xcodebuild test \
  -scheme jizhang \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  -enableCodeCoverage YES
```

## âœ… æ ¸å¿ƒæµ‹è¯•åœºæ™¯

### 1. æ•°æ®æ¨¡å‹æµ‹è¯•

#### äº¤æ˜“æ¨¡å‹ï¼ˆTransactionModelTestsï¼‰
- âœ… äº¤æ˜“ç±»å‹æšä¸¾ï¼ˆæ”¯å‡ºã€æ”¶å…¥ã€è½¬è´¦ã€è°ƒæ•´ï¼‰
- âœ… é‡‘é¢æ˜¾ç¤ºæ ¼å¼ï¼ˆå¸¦æ­£è´Ÿå·ï¼‰
- âœ… è´¦æˆ·ä½™é¢æ›´æ–°é€»è¾‘
- âœ… è´¦æˆ·ä½™é¢æ’¤é”€é€»è¾‘
- âœ… ä¸»è¦è´¦æˆ·è·å–

#### è´¦æˆ·æ¨¡å‹ï¼ˆAccountModelTestsï¼‰
- âœ… è´¦æˆ·ç±»å‹ï¼ˆç°é‡‘ã€å‚¨è“„å¡ã€ä¿¡ç”¨å¡ã€ç”µå­é’±åŒ…ï¼‰
- âœ… å¯ç”¨ä½™é¢è®¡ç®—ï¼ˆä¿¡ç”¨å¡ç‰¹æ®Šå¤„ç†ï¼‰
- âœ… ä½™é¢è°ƒæ•´åŠŸèƒ½
- âœ… è´¦æˆ·å½’æ¡£çŠ¶æ€

#### åˆ†ç±»æ¨¡å‹ï¼ˆCategoryModelTestsï¼‰
- âœ… åˆ†ç±»å±‚çº§ç»“æ„ï¼ˆçˆ¶å­å…³ç³»ï¼‰
- âœ… å®Œæ•´è·¯å¾„åæ˜¾ç¤º
- âœ… æ‰€æœ‰äº¤æ˜“èšåˆï¼ˆåŒ…å«å­åˆ†ç±»ï¼‰
- âœ… å¿«é€Ÿé€‰æ‹©æ ‡è®°

#### é¢„ç®—æ¨¡å‹ï¼ˆBudgetModelTestsï¼‰
- âœ… é¢„ç®—å‘¨æœŸè®¡ç®—ï¼ˆæœˆåº¦ã€å¹´åº¦ã€è‡ªå®šä¹‰ï¼‰
- âœ… å·²ä½¿ç”¨é‡‘é¢è®¡ç®—
- âœ… å‰©ä½™é‡‘é¢å’Œè¿›åº¦
- âœ… é¢„ç®—çŠ¶æ€åˆ¤æ–­ï¼ˆå®‰å…¨ã€æ³¨æ„ã€é¢„è­¦ã€è¶…æ”¯ï¼‰
- âœ… é¢„ç®—ç»“è½¬åŠŸèƒ½

#### è´¦æœ¬æ¨¡å‹ï¼ˆLedgerModelTestsï¼‰
- âœ… æ€»èµ„äº§è®¡ç®—ï¼ˆæ’é™¤å½’æ¡£å’Œç‰¹å®šè´¦æˆ·ï¼‰
- âœ… é»˜è®¤è´¦æœ¬å”¯ä¸€æ€§
- âœ… é»˜è®¤åˆ†ç±»å’Œè´¦æˆ·åˆ›å»º

### 2. é›†æˆæµ‹è¯•

#### è´¦æœ¬éš”ç¦»æµ‹è¯•ï¼ˆLedgerIsolationTestsï¼‰
- âœ… è´¦æœ¬æ•°æ®å®Œå…¨éš”ç¦»
- âœ… äº¤æ˜“ã€é¢„ç®—ã€æ ‡ç­¾éš”ç¦»
- âœ… çº§è”åˆ é™¤åŠŸèƒ½
- âœ… è´¦æœ¬åˆ‡æ¢ä¸å½±å“æ•°æ®
- âœ… è´¦æœ¬è®¾ç½®å¤åˆ¶

#### è´¦æˆ·ä½™é¢ä¸€è‡´æ€§æµ‹è¯•ï¼ˆAccountBalanceConsistencyTestsï¼‰
- âœ… å¤šç¬”äº¤æ˜“ä½™é¢æ­£ç¡®æ€§
- âœ… åˆ é™¤äº¤æ˜“åä½™é¢å›æ»š
- âœ… è½¬è´¦åŒå‘ä½™é¢å˜åŒ–
- âœ… ä¿¡ç”¨å¡å¯ç”¨é¢åº¦è®¡ç®—
- âœ… æ”¶å…¥æ”¯å‡ºæ··åˆåœºæ™¯

#### é¢„ç®—è¿½è¸ªæµ‹è¯•ï¼ˆBudgetTrackingTestsï¼‰
- âœ… å¤šç¬”æ”¯å‡ºç´¯è®¡åˆ°é¢„ç®—
- âœ… å­åˆ†ç±»æ”¯å‡ºè®¡å…¥çˆ¶åˆ†ç±»é¢„ç®—
- âœ… é¢„ç®—è¶…æ”¯è­¦å‘Šï¼ˆ4ä¸ªçŠ¶æ€ï¼‰
- âœ… é¢„ç®—ç»“è½¬åŠŸèƒ½
- âœ… å¤šä¸ªé¢„ç®—åŒæ—¶è¿½è¸ª

### 3. UIæµç¨‹æµ‹è¯•

#### è®°è´¦æµç¨‹ï¼ˆTransactionFlowUITestsï¼‰
- âœ… æ·»åŠ æ”¯å‡ºäº¤æ˜“
- âœ… æ·»åŠ æ”¶å…¥äº¤æ˜“
- âœ… æ·»åŠ è½¬è´¦äº¤æ˜“
- âœ… ç¼–è¾‘äº¤æ˜“
- âœ… åˆ é™¤äº¤æ˜“
- âœ… å¿«é€Ÿåˆ†ç±»é€‰æ‹©
- âœ… æ—¥æœŸé€‰æ‹©
- âœ… å¤‡æ³¨è¾“å…¥

## ğŸ› ï¸ æµ‹è¯•è¾…åŠ©å·¥å…·

### TestHelpers

æä¾›å¿«é€Ÿåˆ›å»ºæµ‹è¯•æ•°æ®çš„è¾…åŠ©å‡½æ•°ï¼š

```swift
// åˆ›å»ºæµ‹è¯•è´¦æœ¬
let ledger = TestHelpers.createTestLedger(context: modelContext)

// åˆ›å»ºå®Œæ•´æµ‹è¯•è´¦æœ¬ï¼ˆåŒ…å«è´¦æˆ·å’Œåˆ†ç±»ï¼‰
let fullLedger = TestHelpers.createFullTestLedger(context: modelContext)

// åˆ›å»ºæµ‹è¯•è´¦æˆ·
let account = TestHelpers.createTestAccount(
    ledger: ledger,
    balance: 1000,
    context: modelContext
)

// åˆ›å»ºæµ‹è¯•äº¤æ˜“
let transaction = TestHelpers.createTestTransaction(
    ledger: ledger,
    amount: 100,
    type: .expense,
    context: modelContext
)

// åˆ›å»ºæŒ‡å®šæ—¥æœŸ
let date = TestHelpers.date(year: 2026, month: 1, day: 15)
```

### MockData

ç”Ÿæˆæ‰¹é‡æµ‹è¯•æ•°æ®ï¼š

```swift
// æ‰¹é‡åˆ›å»ºäº¤æ˜“
let transactions = MockData.createMultipleTransactions(
    ledger: ledger,
    account: account,
    category: category,
    count: 50,
    context: modelContext
)

// åˆ›å»ºæœ¬æœˆäº¤æ˜“æ•°æ®
MockData.createMonthlyTransactions(
    ledger: ledger,
    accounts: accounts,
    categories: categories,
    context: modelContext
)

// åˆ›å»ºå¤§é‡æ•°æ®ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰
MockData.createLargeDataset(
    ledger: ledger,
    transactionCount: 1000,
    context: modelContext
)
```

### UITestHelpers

ç®€åŒ–UIæµ‹è¯•ä»£ç ï¼š

```swift
let helper = UITestHelpers(app: app)

// å¯åŠ¨åº”ç”¨
helper.launchApp(resetState: true)

// å¯¼èˆªæ“ä½œ
helper.switchToTab("é¦–é¡µ")
helper.tapButton("æ·»åŠ ")
helper.goBack()

// è¾“å…¥æ“ä½œ
helper.enterText("æµ‹è¯•", inField: "å¤‡æ³¨")
helper.enterAmount("100.50")

// éªŒè¯æ“ä½œ
helper.verifyTextExists("äº¤æ˜“å·²ä¿å­˜")
helper.waitForElement(element, timeout: 5)

// æˆªå›¾ï¼ˆç”¨äºè°ƒè¯•ï¼‰
helper.takeScreenshot(name: "æ·»åŠ äº¤æ˜“é¡µé¢")
```

## ğŸ“ˆ æµ‹è¯•è¦†ç›–ç›®æ ‡

- âœ… **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**: 100%
- ğŸ”„ **æ•´ä½“ä»£ç è¦†ç›–ç‡**: ç›®æ ‡ â‰¥80% (å½“å‰çº¦40%)
- âœ… **ViewModel**: â‰¥85%
- âœ… **Service**: â‰¥80%
- âœ… **Modelè®¡ç®—å±æ€§**: 100%

## ğŸ› è°ƒè¯•æµ‹è¯•

### åœ¨Xcodeä¸­è°ƒè¯•
1. åœ¨æµ‹è¯•ä»£ç ä¸­è®¾ç½®æ–­ç‚¹
2. å³é”®ç‚¹å‡»æµ‹è¯•æ–¹æ³• â†’ "Debug Test"
3. ä½¿ç”¨ `po` å‘½ä»¤æŸ¥çœ‹å˜é‡å€¼

### æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
```bash
# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
xcodebuild test \
  -scheme jizhang \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  -only-testing:jizhangTests | xcpretty
```

### UIæµ‹è¯•æˆªå›¾
UIæµ‹è¯•å¤±è´¥æ—¶ä¼šè‡ªåŠ¨ä¿å­˜æˆªå›¾ï¼Œä½ç½®ï¼š
```
~/Library/Developer/Xcode/DerivedData/.../Logs/Test/Attachments/
```

## ğŸ”„ æŒç»­é›†æˆ

æ¨èçš„GitHub Actionsé…ç½®ï¼š

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.2.app
    
    - name: Run Tests
      run: |
        xcodebuild test \
          -scheme jizhang \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -enableCodeCoverage YES \
          | xcpretty
    
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
```

## ğŸ“ ç¼–å†™æ–°æµ‹è¯•

### å•å…ƒæµ‹è¯•æ¨¡æ¿

```swift
import XCTest
import SwiftData
@testable import jizhang

@MainActor
final class MyFeatureTests: XCTestCase {
    
    var modelContainer: ModelContainer!
    var modelContext: ModelContext!
    
    override func setUp() async throws {
        modelContainer = try TestHelpers.createInMemoryContainer()
        modelContext = ModelContext(modelContainer)
    }
    
    override func tearDown() async throws {
        try TestHelpers.cleanup(context: modelContext)
        modelContainer = nil
        modelContext = nil
    }
    
    func testSomething() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        let ledger = TestHelpers.createTestLedger(context: modelContext)
        
        // æ‰§è¡Œæ“ä½œ
        // ...
        
        // éªŒè¯ç»“æœ
        XCTAssertEqual(expected, actual)
    }
}
```

### UIæµ‹è¯•æ¨¡æ¿

```swift
import XCTest

final class MyFeatureUITests: XCTestCase {
    
    var app: XCUIApplication!
    var helper: UITestHelpers!
    
    override func setUpWithError() throws {
        continueAfterFailure = false
        app = XCUIApplication()
        helper = UITestHelpers(app: app)
        helper.launchApp(resetState: true)
    }
    
    func testUserFlow() throws {
        // æ‰§è¡Œç”¨æˆ·æ“ä½œ
        helper.tapButton("å¼€å§‹")
        
        // éªŒè¯ç»“æœ
        helper.verifyTextExists("æˆåŠŸ")
    }
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•å®ç°æ€»ç»“](./æµ‹è¯•å®ç°æ€»ç»“.md)
- [æ•°æ®æ¨¡å‹è®¾è®¡](./æ•°æ®æ¨¡å‹è®¾è®¡.md)
- [CloudKitä¿®å¤è¯´æ˜](./CloudKitä¿®å¤è¯´æ˜_v6.md)

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹** - ä½¿ç”¨setUp/tearDownç¡®ä¿æµ‹è¯•éš”ç¦»
2. **ä½¿ç”¨å†…å­˜æ•°æ®åº“** - é¿å…æ±¡æŸ“çœŸå®æ•°æ®
3. **æµ‹è¯•å‘½åæ¸…æ™°** - ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•æ–¹æ³•å
4. **ä¸€ä¸ªæµ‹è¯•ä¸€ä¸ªæ–­è¨€** - å°½å¯èƒ½ä¿æŒæµ‹è¯•ç®€å•
5. **ä½¿ç”¨è¾…åŠ©å‡½æ•°** - å‡å°‘é‡å¤ä»£ç 
6. **å®šæœŸè¿è¡Œæµ‹è¯•** - åœ¨æäº¤å‰è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

## ğŸ“ æ”¯æŒ

å¦‚æœ‰æµ‹è¯•ç›¸å…³é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æµ‹è¯•å®ç°æ€»ç»“æ–‡æ¡£
2. æ£€æŸ¥ç°æœ‰æµ‹è¯•ç”¨ä¾‹ä½œä¸ºå‚è€ƒ
3. æŸ¥çœ‹TestHelpersä¸­çš„è¾…åŠ©å‡½æ•°

---

**æµ‹è¯•æ˜¯ä¿è¯ä»£ç è´¨é‡çš„ç¬¬ä¸€é“é˜²çº¿ã€‚è®©æˆ‘ä»¬ä¸€èµ·ç»´æŠ¤é«˜è´¨é‡çš„æµ‹è¯•å¥—ä»¶ï¼** ğŸ¯
