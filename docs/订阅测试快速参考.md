# 订阅测试快速参考

## 核心结论

✅ **会员时间计算是正确的！**

您看到的"年度会员有效期到2026.2.1"（而不是2027.2.1）是**正常的沙盒测试行为**：

```
真实环境：1年订阅 = 365天
沙盒环境：1年订阅 = 1小时 ⏰
```

苹果沙盒将订阅周期加速了 **8,760倍**，便于快速测试订阅过期和自动续订。

## 快速重置订阅测试

### 方法1：App内调试工具（最快）

1. 打开App → 设置 → 顶部订阅状态卡片
2. 滚动到底部"🔧 调试工具"区域
3. 点击"清除本地订阅缓存"
4. 完成！App会重新检测订阅状态

**注意：** 这只清除本地缓存，不删除App Store购买记录

### 方法2：管理沙盒订阅（彻底清理）

1. 设备设置 → App Store
2. 沙盒账户 → 点击测试账号
3. 管理 → 取消/删除订阅
4. 重启App

## 调试工具功能

在订阅页面底部（仅DEBUG模式）：

| 功能 | 说明 |
|-----|------|
| 当前状态 | 显示订阅类型和过期时间 |
| 剩余时间 | 实时倒计时（沙盒1小时） |
| 打印详情 | 输出所有交易信息到控制台 |
| 清除缓存 | 重置本地订阅状态 |

## 沙盒测试周期对照表

| 真实环境 | 沙盒环境 |
|---------|---------|
| 1周 | 3分钟 ⚡ |
| 1月 | 5分钟 ⚡ |
| 2月 | 10分钟 ⚡ |
| 3月 | 15分钟 ⚡ |
| 6月 | 30分钟 ⚡ |
| **1年** | **1小时** ⚡ |

## 常见测试场景

### 测试购买
```
1. 确保免费状态（使用调试工具清除缓存）
2. 点击任意付费功能
3. 选择订阅方案并购买
4. 验证功能解锁
```

### 测试过期
```
1. 购买年订阅
2. 记录当前时间
3. 等待1小时
4. 验证功能重新锁定
```

### 测试恢复
```
1. 购买订阅
2. 清除本地缓存
3. 点击"恢复购买"
4. 验证订阅恢复
```

## 代码位置

- 订阅管理器：`jizhang/Services/SubscriptionManager.swift`
- 调试方法：
  - `clearLocalSubscriptionCache()` - 清除缓存
  - `printSubscriptionDetails()` - 打印详情
- 订阅页面：`jizhang/Views/Subscription/SubscriptionView.swift`
- 调试UI：`debugSection` (仅DEBUG模式)

## 注意事项

⚠️ **沙盒vs真实环境**

| 特性 | 沙盒 | 真实 |
|-----|------|------|
| 周期 | 加速 | 正常 |
| 扣款 | 不扣 | 真实扣款 |
| 续订 | 最多6次 | 无限制 |
| 账号 | 测试账号 | 真实Apple ID |

⚠️ **测试账号使用规则**

- ✅ 只在App内购买时登录沙盒账号
- ❌ 不要在设置→Apple ID中登录测试账号
- ❌ 不要用真实Apple ID测试沙盒购买

## 验证清单

上架前检查：

- [ ] 在真实设备测试完整购买流程
- [ ] 测试订阅过期后的限制
- [ ] 测试恢复购买功能
- [ ] 测试自动续订（等待1小时）
- [ ] 验证所有付费功能的权限检查
- [ ] 关闭或隐藏调试工具（生产环境）

## 更多信息

详细说明请查看：`docs/订阅测试指南.md`
