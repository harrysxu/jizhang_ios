# 小组件修复说明

## 修复时间
2026-01-31

## 发现的问题

### 1. 预算使用率计算逻辑错误 ✅ 已修复

**问题描述:**
- Small Widget 显示的是"今日支出"卡片,但预算使用率计算使用的是月度数据
- 原代码: `budgetUsage = monthExpense / monthBudget`
- 这导致"今日支出"卡片上显示的百分比和进度条实际反映的是月度预算使用情况,与卡片主题不符

**修复方案:**
- 修改为: `budgetUsage = todayExpense / todayBudget`
- 现在预算使用率正确反映今日支出占今日预算的比例

**修改文件:**
- `jizhang/jizhangWidget/Services/WidgetDataService.swift` (第108行)

### 2. 分类图标显示问题 ✅ 已修复

**问题描述:**
- 小组件直接使用数据库中存储的图标名称显示图标
- 数据库中可能存储的是 Phosphor 图标名称(如 `forkKnife`),但小组件使用 `Image(systemName:)` 直接显示
- 这会导致图标无法正常显示,因为 SF Symbols 中没有对应名称的图标

**修复方案:**
- 在 `WidgetDataService.swift` 中添加 `convertToSFSymbol()` 方法
- 转换时支持:
  - Phosphor 图标名称 → SF Symbol 名称 (如 `forkKnife` → `fork.knife`)
  - 已经是 SF Symbol 名称的直接返回
  - 无法识别的返回默认图标 `questionmark.circle.fill`
- 在创建 `WidgetTransaction` 时自动转换图标名称

**修改文件:**
- `jizhang/jizhangWidget/Services/WidgetDataService.swift` (添加 `convertToSFSymbol()` 方法)
- `jizhang/jizhangWidget/Services/WidgetDataService.swift` (修改第115-130行,在转换交易数据时调用转换方法)

### 3. 日期范围计算一致性 ✅ 确认无问题

**检查结果:**
- **小组件**: 使用 `calendar.startOfDay(for:)` 和日期加减计算范围
- **App**: 使用 `Date+Extensions` 中的 `isToday` 和 `isThisMonth` 方法
- 两种实现方式底层都使用 `Calendar` 的标准方法,逻辑等价
- **结论**: 无需修改,当前实现正确且一致

## 修复代码对比

### 预算使用率计算

**修复前:**
```swift
// 8. 计算预算使用率
let budgetUsage = monthBudget > 0 ? Double(truncating: (monthExpense / monthBudget) as NSNumber) : 0
```

**修复后:**
```swift
// 8. 计算预算使用率（今日支出 / 今日预算）
let budgetUsage = todayBudget > 0 ? Double(truncating: (todayExpense / todayBudget) as NSNumber) : 0
```

### 图标名称转换

**修复前:**
```swift
let simpleTransactions = monthTransactions
    .sorted { $0.date > $1.date }
    .prefix(5)
    .map { transaction in
        WidgetTransaction(
            id: transaction.id,
            amount: transaction.amount,
            categoryName: transaction.category?.name ?? "未分类",
            categoryIcon: transaction.category?.iconName ?? "questionmark.circle",  // ❌ 直接使用可能是错误的
            date: transaction.date,
            type: transaction.type.rawValue,
            note: transaction.note
        )
    }
```

**修复后:**
```swift
let simpleTransactions = monthTransactions
    .sorted { $0.date > $1.date }
    .prefix(5)
    .map { transaction in
        // 转换图标名称为 SF Symbol（兼容旧的 Phosphor 名称）
        let iconName = transaction.category?.iconName ?? "questionmark.circle"
        let sfSymbolName = convertToSFSymbol(iconName)  // ✅ 转换为正确的 SF Symbol 名称
        
        return WidgetTransaction(
            id: transaction.id,
            amount: transaction.amount,
            categoryName: transaction.category?.name ?? "未分类",
            categoryIcon: sfSymbolName,
            date: transaction.date,
            type: transaction.type.rawValue,
            note: transaction.note
        )
    }
```

## 测试建议

### 1. 预算使用率测试
- 创建一个每日预算(如 200 元)
- 添加今日支出交易(如 150 元)
- 检查小组件是否显示 75% (150/200)
- 添加更多今日支出使其超过预算
- 检查小组件是否正确显示超支状态(红色图标和"超支"文字)

### 2. 图标显示测试
- 检查小组件中最近交易列表的图标是否正确显示
- 特别关注:
  - 餐饮类(fork.knife)
  - 交通类(bus.fill, car.fill)
  - 购物类(bag.fill)
  - 收入类(dollarsign.circle.fill, briefcase.fill)

### 3. 数据一致性测试
- 在 App 中查看首页的今日支出和本月收支数据
- 在小组件中查看相同数据
- 确认数值完全一致

## 影响范围

### 修改的文件
- `jizhang/jizhangWidget/Services/WidgetDataService.swift`

### 影响的组件
- Small Widget (今日支出快览)
- Medium Widget (今日支出 + 最近流水)
- Large Widget (本月概览 + 最近流水)

### 不影响的部分
- App 主程序的数据计算逻辑
- 数据库结构
- 其他业务逻辑

## 后续优化建议

1. **添加单元测试**
   - 为 `WidgetDataService` 添加单元测试
   - 测试日期范围计算、金额统计、图标转换等核心逻辑

2. **统一图标管理**
   - 考虑在数据库中统一使用 SF Symbol 名称
   - 或在 Category 模型中添加转换逻辑

3. **预算计算优化**
   - 支持多个预算的独立计算和展示
   - 支持自定义预算周期(周、月、年)

4. **错误处理**
   - 添加更详细的错误日志
   - 当数据获取失败时显示友好的错误提示
