# 会员系统环境配置说明

## 📋 概述

为了方便开发和测试，会员系统已配置为：
- **测试环境（DEBUG）**：默认为高级会员，所有付费功能均可免费使用
- **正式环境（RELEASE）**：会员系统正常生效，需要购买订阅才能使用付费功能

## 🔧 实现细节

### 1. 修改的文件
`jizhang/jizhang/Services/SubscriptionManager.swift`

### 2. 主要修改点

#### (1) `SubscriptionStatus.isPremium` 计算属性
```swift
var isPremium: Bool {
    // 测试环境默认为高级会员
    #if DEBUG
    return true
    #else
    switch self {
    case .free:
        return false
    case .premium, .lifetime:
        return true
    }
    #endif
}
```

**说明**：
- DEBUG 模式：无论实际订阅状态如何，总是返回 `true`
- RELEASE 模式：根据实际订阅状态判断

#### (2) `hasAccess(to:)` 方法
```swift
func hasAccess(to feature: PremiumFeature) -> Bool {
    // 测试环境：默认拥有所有权限（除非开启了付费测试）
    #if DEBUG
    if !Self.testSubscriptionSystem {
        return true
    }
    #endif
    
    // 正式环境或测试付费限制时：检查订阅状态
    return subscriptionStatus.isPremium
}
```

**说明**：
- DEBUG 模式下，默认返回 `true`，授予所有权限
- 可通过 `testSubscriptionSystem` 开关临时启用付费限制测试
- RELEASE 模式正常检查订阅状态

#### (3) 新增调试开关
```swift
#if DEBUG
static let testSubscriptionSystem: Bool = false  // true = 测试付费限制，false = 默认高级会员
#endif
```

## 🎯 使用场景

### 场景 1：日常开发（默认）
**配置**：`testSubscriptionSystem = false`（默认）
- 所有付费功能都可以直接使用
- 无需购买订阅即可测试所有功能
- 提高开发效率

### 场景 2：测试付费流程
**配置**：`testSubscriptionSystem = true`
- 启用付费限制
- 可以测试订阅购买流程
- 可以测试付费墙的UI展示

### 场景 3：正式发布
**配置**：无需配置（自动生效）
- 编译 RELEASE 版本时，会员系统自动生效
- 用户需要购买订阅才能使用付费功能
- 订阅状态从 App Store 获取

## 🔍 影响的付费功能

所有通过 `PremiumFeature` 枚举定义的功能都受此配置影响：

1. **账户管理** (`accountManagement`)
2. **分类管理** (`categoryManagement`)
3. **预算管理** (`budgetManagement`)
4. **数据导出** (`exportData`)
5. **导出账本** (`exportLedger`)
6. **导入账本** (`importLedger`)
7. **删除账本** (`deleteLedger`)
8. **重置账本** (`resetLedger`)
9. **对比分析** (`comparisonReport`)
10. **趋势分析** (`trendReport`)
11. **账户统计** (`accountStatistics`)
12. **iCloud同步** (`cloudSync`)

## ✅ 测试建议

### 开发阶段
1. 保持 `testSubscriptionSystem = false`
2. 专注于功能开发，无需关心付费限制

### 提交前测试
1. 将 `testSubscriptionSystem` 改为 `true`
2. 测试付费墙是否正确显示
3. 测试订阅购买流程是否正常
4. 测试完成后改回 `false`

### 发布前验证
1. 编译 RELEASE 版本
2. 使用 TestFlight 进行真机测试
3. 验证会员系统在真实环境下的表现

## 🚀 编译配置

| 编译配置 | 环境 | 会员系统行为 |
|---------|------|-------------|
| DEBUG | 测试环境 | 默认高级会员（可通过开关临时启用限制） |
| RELEASE | 正式环境 | 正常验证订阅状态 |

## 📝 注意事项

1. **不要在 RELEASE 版本中修改代码**：所有调试开关仅在 DEBUG 模式下有效
2. **Git 提交前检查**：确保 `testSubscriptionSystem = false`，避免影响其他开发者
3. **文档同步**：如有修改，请同步更新此文档

## 🐛 常见问题

### Q1: 为什么测试环境看不到付费墙？
A: 这是预期行为。测试环境默认为高级会员，所有功能都可用。如需测试付费墙，请将 `testSubscriptionSystem` 设置为 `true`。

### Q2: 如何测试订阅购买流程？
A: 
1. 将 `testSubscriptionSystem` 设置为 `true`
2. 重新编译运行
3. 此时会显示付费限制，可以进入订阅页面测试

### Q3: 正式环境会受影响吗？
A: 不会。所有调试配置都用 `#if DEBUG` 包裹，RELEASE 版本会自动使用正确的会员验证逻辑。

### Q4: 如何确认当前环境？
A: 在订阅页面底部有调试信息显示（仅 DEBUG 模式可见），会显示当前环境和订阅状态。

## 📚 相关文档

- [快速发布指南.md](快速发布指南.md)
- [发布总结.md](发布总结.md)
- StoreKit 2 官方文档

---

**最后更新**：2026年1月31日
**修改人**：Cursor AI
