# iOSè®°è´¦åº”ç”¨æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: Lumina (è®°è´¦App)
- **ç‰ˆæœ¬**: v1.0
- **æœ€ä½æ”¯æŒ**: iOS 17.0+
- **æ¶æ„æ¨¡å¼**: MVVM + Repository Pattern
- **åˆ›å»ºæ—¥æœŸ**: 2026-01-24

---

## 1. æŠ€æœ¯æ ˆé€‰å‹

### 1.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | é€‰å‹ | ç‰ˆæœ¬è¦æ±‚ | é€‰æ‹©ç†ç”± |
|---------|------|---------|---------|
| **UIæ¡†æ¶** | SwiftUI | iOS 17.0+ | 1. åŸç”Ÿæ€§èƒ½æœ€ä¼˜<br>2. å£°æ˜å¼UIå¼€å‘æ•ˆç‡é«˜<br>3. å®Œç¾æ”¯æŒiOSæœ€æ–°ç‰¹æ€§<br>4. è‡ªåŠ¨é€‚é…Dark Mode |
| **æ•°æ®æŒä¹…åŒ–** | SwiftData | iOS 17.0+ | 1. Appleæœ€æ–°æ¨èæ–¹æ¡ˆ<br>2. ä¸SwiftUIæ·±åº¦é›†æˆ<br>3. ç®€åŒ–æ•°æ®æ¨¡å‹å®šä¹‰<br>4. è‡ªåŠ¨iCloudåŒæ­¥æ”¯æŒ |
| **äº‘åŒæ­¥** | CloudKit | - | 1. ç”¨æˆ·æ•°æ®å®Œå…¨éšç§<br>2. å…è´¹é¢åº¦å……è¶³<br>3. è‡ªåŠ¨å¤„ç†å†²çª<br>4. æ— éœ€è‡ªå»ºåç«¯ |
| **å›¾è¡¨åº“** | Swift Charts | iOS 16.0+ | 1. AppleåŸç”Ÿå›¾è¡¨æ¡†æ¶<br>2. æ€§èƒ½ä¼˜å¼‚<br>3. è‡ªåŠ¨é€‚é…ç³»ç»Ÿä¸»é¢˜<br>4. æ— ç¬¬ä¸‰æ–¹ä¾èµ– |
| **å¹¶å‘å¤„ç†** | Swift Concurrency | Swift 5.5+ | 1. async/awaitç®€åŒ–å¼‚æ­¥ä»£ç <br>2. Actorä¿è¯çº¿ç¨‹å®‰å…¨<br>3. TaskGroupå¤„ç†å¹¶å‘ä»»åŠ¡ |

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©çº¯SwiftUIï¼Ÿ

**å¯¹æ¯”åˆ†æ**ï¼š

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **çº¯SwiftUI** | â€¢ å¼€å‘æ•ˆç‡æœ€é«˜<br>â€¢ ä»£ç é‡å°‘30-40%<br>â€¢ å®Œç¾æ”¯æŒæ–°ç‰¹æ€§ | â€¢ éœ€iOS 17+<br>â€¢ éƒ¨åˆ†ç»„ä»¶éœ€è‡ªå®šä¹‰ | âœ… æ–°é¡¹ç›®<br>âœ… å¿«é€Ÿè¿­ä»£ |
| SwiftUI+UIKit | â€¢ å…¼å®¹è€ç‰ˆæœ¬<br>â€¢ å¤ç”¨ç°æœ‰UIKit | â€¢ ä»£ç å¤æ‚åº¦å¢åŠ <br>â€¢ ç»´æŠ¤æˆæœ¬é«˜ | âŒ æœ¬é¡¹ç›®ä¸éœ€è¦ |
| UIKit | â€¢ æˆç†Ÿç¨³å®š<br>â€¢ å…¼å®¹æ€§å¼º | â€¢ å¼€å‘æ•ˆç‡ä½<br>â€¢ æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§ | âŒ è¿‡æ—¶æ–¹æ¡ˆ |

**ç»“è®º**: æœ¬é¡¹ç›®ä¸ºå…¨æ–°å¼€å‘ï¼Œç›®æ ‡ç”¨æˆ·ä¸ºiOSé«˜ç‰ˆæœ¬ç”¨æˆ·ï¼Œçº¯SwiftUIæ˜¯æœ€ä½³é€‰æ‹©ã€‚

---

## 2. æ¶æ„æ¨¡å¼è®¾è®¡

### 2.1 MVVMæ¶æ„

```mermaid
graph LR
    View[Viewå±‚<br/>SwiftUI] --> ViewModel[ViewModelå±‚<br/>ä¸šåŠ¡é€»è¾‘]
    ViewModel --> Repository[Repositoryå±‚<br/>æ•°æ®è®¿é—®]
    Repository --> SwiftData[SwiftData<br/>æœ¬åœ°å­˜å‚¨]
    Repository --> CloudKit[CloudKit<br/>äº‘åŒæ­¥]
    
    ViewModel -.çŠ¶æ€æ›´æ–°.-> View
    
    style View fill:#e1f5ff
    style ViewModel fill:#fff4e1
    style Repository fill:#f0f0f0
    style SwiftData fill:#e8f5e9
    style CloudKit fill:#e8f5e9
```

### 2.2 å±‚çº§èŒè´£åˆ’åˆ†

#### **Viewå±‚** (è§†å›¾å±‚)
- **èŒè´£**: 
  - ä»…è´Ÿè´£UIæ¸²æŸ“
  - å“åº”ç”¨æˆ·äº¤äº’
  - ç»‘å®šViewModelçŠ¶æ€
- **æŠ€æœ¯**: SwiftUI
- **ç¤ºä¾‹æ–‡ä»¶**: `HomeView.swift`, `AddTransactionView.swift`

```swift
// ç¤ºä¾‹ï¼šViewå±‚ä»£ç ç»“æ„
struct HomeView: View {
    @StateObject private var viewModel = HomeViewModel()
    
    var body: some View {
        // çº¯UIä»£ç ï¼Œæ— ä¸šåŠ¡é€»è¾‘
        ScrollView {
            NetAssetCard(amount: viewModel.totalAssets)
            TransactionList(transactions: viewModel.transactions)
        }
        .onAppear { viewModel.loadData() }
    }
}
```

#### **ViewModelå±‚** (è§†å›¾æ¨¡å‹å±‚)
- **èŒè´£**:
  - å¤„ç†ä¸šåŠ¡é€»è¾‘
  - ç®¡ç†UIçŠ¶æ€
  - è°ƒç”¨Repositoryè·å–æ•°æ®
  - æ•°æ®è½¬æ¢ä¸æ ¼å¼åŒ–
- **æŠ€æœ¯**: ObservableObject + @Published
- **ç¤ºä¾‹æ–‡ä»¶**: `HomeViewModel.swift`, `TransactionViewModel.swift`

```swift
// ç¤ºä¾‹ï¼šViewModelå±‚ä»£ç ç»“æ„
@MainActor
class HomeViewModel: ObservableObject {
    @Published var totalAssets: Decimal = 0
    @Published var transactions: [Transaction] = []
    @Published var isLoading = false
    
    private let repository: DataRepository
    
    init(repository: DataRepository = .shared) {
        self.repository = repository
    }
    
    func loadData() async {
        isLoading = true
        defer { isLoading = false }
        
        // ä»Repositoryè·å–æ•°æ®
        totalAssets = await repository.calculateTotalAssets()
        transactions = await repository.getRecentTransactions()
    }
}
```

#### **Repositoryå±‚** (æ•°æ®è®¿é—®å±‚)
- **èŒè´£**:
  - å°è£…æ•°æ®è®¿é—®é€»è¾‘
  - ç»Ÿä¸€æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
  - å¤„ç†æ•°æ®ç¼“å­˜
  - æä¾›ç»Ÿä¸€APIç»™ViewModel
- **æŠ€æœ¯**: Actor (çº¿ç¨‹å®‰å…¨)
- **ç¤ºä¾‹æ–‡ä»¶**: `DataRepository.swift`

```swift
// ç¤ºä¾‹ï¼šRepositoryå±‚ä»£ç ç»“æ„
actor DataRepository {
    static let shared = DataRepository()
    
    private let modelContext: ModelContext
    
    func getRecentTransactions(limit: Int = 50) async -> [Transaction] {
        // ä»SwiftDataè·å–æ•°æ®
    }
    
    func saveTransaction(_ transaction: Transaction) async throws {
        // ä¿å­˜åˆ°SwiftDataï¼Œè‡ªåŠ¨åŒæ­¥åˆ°CloudKit
    }
}
```

### 2.3 æ•°æ®æµå‘

```mermaid
sequenceDiagram
    participant User
    participant View
    participant ViewModel
    participant Repository
    participant SwiftData
    participant CloudKit
    
    User->>View: ç‚¹å‡»"æ·»åŠ äº¤æ˜“"
    View->>ViewModel: addTransaction()
    ViewModel->>Repository: save(transaction)
    Repository->>SwiftData: insert(model)
    SwiftData->>SwiftData: æœ¬åœ°æŒä¹…åŒ–
    SwiftData-->>Repository: ä¿å­˜æˆåŠŸ
    Repository->>CloudKit: åå°è‡ªåŠ¨åŒæ­¥
    Repository-->>ViewModel: è¿”å›ç»“æœ
    ViewModel->>ViewModel: æ›´æ–°@PublishedçŠ¶æ€
    ViewModel-->>View: è§¦å‘UIåˆ·æ–°
    View-->>User: æ˜¾ç¤ºæ–°äº¤æ˜“
```

---

## 3. é¡¹ç›®æ–‡ä»¶ç»“æ„

### 3.1 å®Œæ•´ç›®å½•æ ‘

```
jizhang/
â”œâ”€â”€ jizhang/                                    # ä¸»App Target
â”‚   â”œâ”€â”€ App/                                    # åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ jizhangApp.swift                   # Appç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”œâ”€â”€ AppState.swift                     # å…¨å±€çŠ¶æ€ç®¡ç†
â”‚   â”‚   â””â”€â”€ AppDelegate.swift                  # ä¼ ç»ŸAppDelegateï¼ˆé€šçŸ¥ç­‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ Models/                                 # SwiftDataæ¨¡å‹å±‚
â”‚   â”‚   â”œâ”€â”€ Core/
â”‚   â”‚   â”‚   â”œâ”€â”€ Ledger.swift                   # è´¦æœ¬å®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ Account.swift                  # è´¦æˆ·å®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ Category.swift                 # åˆ†ç±»å®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ Transaction.swift              # æµæ°´å®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ Budget.swift                   # é¢„ç®—å®ä½“
â”‚   â”‚   â”‚   â””â”€â”€ Tag.swift                      # æ ‡ç­¾å®ä½“
â”‚   â”‚   â”œâ”€â”€ Enums/
â”‚   â”‚   â”‚   â”œâ”€â”€ AccountType.swift              # è´¦æˆ·ç±»å‹æšä¸¾
â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionType.swift          # äº¤æ˜“ç±»å‹æšä¸¾
â”‚   â”‚   â”‚   â””â”€â”€ BudgetPeriod.swift             # é¢„ç®—å‘¨æœŸæšä¸¾
â”‚   â”‚   â””â”€â”€ ValueTypes/
â”‚   â”‚       â”œâ”€â”€ Money.swift                    # é‡‘é¢å€¼ç±»å‹
â”‚   â”‚       â””â”€â”€ DateRange.swift                # æ—¥æœŸèŒƒå›´
â”‚   â”‚
â”‚   â”œâ”€â”€ ViewModels/                             # è§†å›¾æ¨¡å‹å±‚
â”‚   â”‚   â”œâ”€â”€ Home/
â”‚   â”‚   â”‚   â””â”€â”€ HomeViewModel.swift
â”‚   â”‚   â”œâ”€â”€ Transaction/
â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionListViewModel.swift
â”‚   â”‚   â”‚   â””â”€â”€ AddTransactionViewModel.swift
â”‚   â”‚   â”œâ”€â”€ Report/
â”‚   â”‚   â”‚   â””â”€â”€ ReportViewModel.swift
â”‚   â”‚   â”œâ”€â”€ Budget/
â”‚   â”‚   â”‚   â””â”€â”€ BudgetViewModel.swift
â”‚   â”‚   â””â”€â”€ Settings/
â”‚   â”‚       â”œâ”€â”€ LedgerViewModel.swift
â”‚   â”‚       â””â”€â”€ AccountViewModel.swift
â”‚   â”‚
â”‚   â”œâ”€â”€ Views/                                  # è§†å›¾å±‚
â”‚   â”‚   â”œâ”€â”€ Root/
â”‚   â”‚   â”‚   â””â”€â”€ MainTabView.swift              # æ ¹TabView
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Home/
â”‚   â”‚   â”‚   â”œâ”€â”€ HomeView.swift                 # é¦–é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ NetAssetCard.swift             # å‡€èµ„äº§å¡ç‰‡
â”‚   â”‚   â”‚   â””â”€â”€ TodayBudgetBar.swift           # ä»Šæ—¥é¢„ç®—æ¡
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Transaction/
â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionListView.swift      # æµæ°´åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionRow.swift           # æµæ°´è¡Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ AddTransactionSheet.swift      # æ·»åŠ äº¤æ˜“Sheet
â”‚   â”‚   â”‚   â”œâ”€â”€ CalculatorKeyboard.swift       # è®¡ç®—å™¨é”®ç›˜
â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryPicker.swift           # åˆ†ç±»é€‰æ‹©å™¨
â”‚   â”‚   â”‚   â””â”€â”€ AccountPicker.swift            # è´¦æˆ·é€‰æ‹©å™¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Report/
â”‚   â”‚   â”‚   â”œâ”€â”€ ReportView.swift               # æŠ¥è¡¨ä¸»é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ Charts/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseBarChart.swift      # æ”¯å‡ºæŸ±çŠ¶å›¾
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryPieChart.swift     # åˆ†ç±»é¥¼å›¾
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NetWorthLineChart.swift    # å‡€èµ„äº§è¶‹åŠ¿
â”‚   â”‚   â”‚   â””â”€â”€ CategoryRankingList.swift      # åˆ†ç±»æ’è¡Œ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Budget/
â”‚   â”‚   â”‚   â”œâ”€â”€ BudgetView.swift               # é¢„ç®—ä¸»é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ BudgetCard.swift               # é¢„ç®—å¡ç‰‡
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateBudgetSheet.swift        # åˆ›å»ºé¢„ç®—
â”‚   â”‚   â”‚   â””â”€â”€ BudgetProgressBar.swift        # é¢„ç®—è¿›åº¦æ¡
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Settings/
â”‚   â”‚   â”‚   â”œâ”€â”€ SettingsView.swift             # è®¾ç½®ä¸»é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ LedgerManagementView.swift     # è´¦æœ¬ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ AccountManagementView.swift    # è´¦æˆ·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ CategoryManagementView.swift   # åˆ†ç±»ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ CloudSyncView.swift            # äº‘åŒæ­¥
â”‚   â”‚   â”‚   â””â”€â”€ ExportDataView.swift           # æ•°æ®å¯¼å‡º
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Components/                         # é€šç”¨ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ Buttons/
â”‚   â”‚       â”‚   â”œâ”€â”€ PrimaryButton.swift
â”‚   â”‚       â”‚   â””â”€â”€ FloatingActionButton.swift
â”‚   â”‚       â”œâ”€â”€ Cards/
â”‚   â”‚       â”‚   â””â”€â”€ CardView.swift
â”‚   â”‚       â”œâ”€â”€ Inputs/
â”‚   â”‚       â”‚   â””â”€â”€ AmountTextField.swift
â”‚   â”‚       â””â”€â”€ Loading/
â”‚   â”‚           â””â”€â”€ LoadingView.swift
â”‚   â”‚
â”‚   â”œâ”€â”€ Services/                               # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ Data/
â”‚   â”‚   â”‚   â”œâ”€â”€ DataRepository.swift           # æ•°æ®ä»“åº“
â”‚   â”‚   â”‚   â””â”€â”€ DataService.swift              # æ•°æ®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ Cloud/
â”‚   â”‚   â”‚   â”œâ”€â”€ CloudSyncService.swift         # CloudKitåŒæ­¥
â”‚   â”‚   â”‚   â””â”€â”€ ConflictResolver.swift         # å†²çªè§£å†³
â”‚   â”‚   â”œâ”€â”€ Export/
â”‚   â”‚   â”‚   â”œâ”€â”€ ExportService.swift            # å¯¼å‡ºæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ CSVExporter.swift              # CSVå¯¼å‡ºå™¨
â”‚   â”‚   â”‚   â””â”€â”€ PDFExporter.swift              # PDFå¯¼å‡ºå™¨
â”‚   â”‚   â”œâ”€â”€ Notification/
â”‚   â”‚   â”‚   â””â”€â”€ NotificationService.swift      # é€šçŸ¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ Analytics/
â”‚   â”‚       â””â”€â”€ AnalyticsService.swift         # ç»Ÿè®¡æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ Utilities/                              # å·¥å…·ç±»
â”‚   â”‚   â”œâ”€â”€ Extensions/
â”‚   â”‚   â”‚   â”œâ”€â”€ Date+Extensions.swift
â”‚   â”‚   â”‚   â”œâ”€â”€ Decimal+Extensions.swift
â”‚   â”‚   â”‚   â”œâ”€â”€ Color+Extensions.swift
â”‚   â”‚   â”‚   â””â”€â”€ View+Extensions.swift
â”‚   â”‚   â”œâ”€â”€ Helpers/
â”‚   â”‚   â”‚   â”œâ”€â”€ CurrencyFormatter.swift        # è´§å¸æ ¼å¼åŒ–
â”‚   â”‚   â”‚   â”œâ”€â”€ DateHelper.swift               # æ—¥æœŸè¾…åŠ©
â”‚   â”‚   â”‚   â””â”€â”€ ValidationHelper.swift         # éªŒè¯è¾…åŠ©
â”‚   â”‚   â”œâ”€â”€ Constants/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppConstants.swift             # åº”ç”¨å¸¸é‡
â”‚   â”‚   â”‚   â”œâ”€â”€ DesignSystem.swift             # è®¾è®¡ç³»ç»Ÿå¸¸é‡
â”‚   â”‚   â”‚   â””â”€â”€ DefaultData.swift              # é»˜è®¤æ•°æ®
â”‚   â”‚   â””â”€â”€ Managers/
â”‚   â”‚       â””â”€â”€ HapticManager.swift            # è§¦è§‰åé¦ˆç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ Resources/                              # èµ„æºæ–‡ä»¶
â”‚       â”œâ”€â”€ Assets.xcassets/
â”‚       â”œâ”€â”€ Localizable.xcstrings              # æœ¬åœ°åŒ–å­—ç¬¦ä¸²
â”‚       â””â”€â”€ Info.plist
â”‚
â”œâ”€â”€ jizhangWidget/                              # Widgetæ‰©å±•
â”‚   â”œâ”€â”€ TodayExpenseWidget.swift               # ä»Šæ—¥æ”¯å‡ºWidget
â”‚   â”œâ”€â”€ BudgetWidget.swift                     # é¢„ç®—Widget
â”‚   â”œâ”€â”€ Providers/
â”‚   â”‚   â””â”€â”€ WidgetTimelineProvider.swift       # Timelineæä¾›è€…
â”‚   â””â”€â”€ Views/
â”‚       â”œâ”€â”€ SmallWidgetView.swift
â”‚       â”œâ”€â”€ MediumWidgetView.swift
â”‚       â””â”€â”€ LargeWidgetView.swift
â”‚
â”œâ”€â”€ LiveActivity/                               # Live Activitiesæ‰©å±•
â”‚   â”œâ”€â”€ ShoppingModeLiveActivity.swift         # è´­ç‰©æ¨¡å¼
â”‚   â”œâ”€â”€ TravelModeLiveActivity.swift           # æ—…è¡Œæ¨¡å¼
â”‚   â””â”€â”€ LiveActivityAttributes.swift           # å±æ€§å®šä¹‰
â”‚
â”œâ”€â”€ jizhangTests/                               # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ ModelTests/
â”‚   â”œâ”€â”€ ViewModelTests/
â”‚   â””â”€â”€ ServiceTests/
â”‚
â””â”€â”€ jizhangUITests/                             # UIæµ‹è¯•
    â”œâ”€â”€ TransactionFlowTests.swift
    â””â”€â”€ ReportInteractionTests.swift
```

### 3.2 æ¨¡å—ä¾èµ–å…³ç³»

```mermaid
graph TD
    App[Appå…¥å£] --> Views[Viewsè§†å›¾å±‚]
    Views --> ViewModels[ViewModelsè§†å›¾æ¨¡å‹]
    ViewModels --> Services[ServicesæœåŠ¡å±‚]
    ViewModels --> Models[Modelsæ¨¡å‹å±‚]
    Services --> Models
    Services --> Utilities[Utilitieså·¥å…·]
    
    Services --> Repository[DataRepository]
    Repository --> SwiftData[SwiftData]
    Repository --> CloudKit[CloudKit]
    
    Widgets[Widgetæ‰©å±•] --> Repository
    LiveActivity[Live Activities] --> Repository
    
    style App fill:#ff6b6b
    style Views fill:#4ecdc4
    style ViewModels fill:#ffe66d
    style Services fill:#95e1d3
    style Models fill:#f38181
    style Utilities fill:#aa96da
```

---

## 4. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 4.1 Appå…¥å£è®¾è®¡

```swift
// jizhangApp.swift
import SwiftUI
import SwiftData

@main
struct jizhangApp: App {
    @StateObject private var appState = AppState()
    
    var body: some Scene {
        WindowGroup {
            MainTabView()
                .environmentObject(appState)
                .modelContainer(appState.modelContainer)
        }
    }
}

// AppState.swift
@MainActor
class AppState: ObservableObject {
    // å…¨å±€çŠ¶æ€
    @Published var currentLedger: Ledger?
    @Published var isCloudSyncEnabled = true
    
    // SwiftDataå®¹å™¨
    let modelContainer: ModelContainer
    
    init() {
        do {
            // é…ç½®SwiftData
            let schema = Schema([
                Ledger.self,
                Account.self,
                Category.self,
                Transaction.self,
                Budget.self,
                Tag.self
            ])
            
            let modelConfiguration = ModelConfiguration(
                schema: schema,
                isStoredInMemoryOnly: false,
                cloudKitDatabase: .automatic // å¯ç”¨CloudKit
            )
            
            modelContainer = try ModelContainer(
                for: schema,
                configurations: [modelConfiguration]
            )
            
            // åŠ è½½å½“å‰è´¦æœ¬
            loadCurrentLedger()
        } catch {
            fatalError("æ— æ³•åˆå§‹åŒ–ModelContainer: \(error)")
        }
    }
    
    private func loadCurrentLedger() {
        // ä»UserDefaultsåŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„è´¦æœ¬
        // å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºé»˜è®¤è´¦æœ¬
    }
}
```

### 4.2 Repositoryæ¨¡å¼å®ç°

```swift
// DataRepository.swift
actor DataRepository {
    static let shared = DataRepository()
    
    private let modelContext: ModelContext
    
    private init() {
        // ä»AppStateè·å–ModelContext
        self.modelContext = AppState.shared.modelContainer.mainContext
    }
    
    // MARK: - Transaction Operations
    
    func fetchTransactions(
        ledger: Ledger,
        startDate: Date? = nil,
        endDate: Date? = nil,
        limit: Int = 50
    ) async -> [Transaction] {
        var descriptor = FetchDescriptor<Transaction>(
            predicate: #Predicate { transaction in
                transaction.ledger == ledger
            },
            sortBy: [SortDescriptor(\.date, order: .reverse)]
        )
        descriptor.fetchLimit = limit
        
        do {
            return try modelContext.fetch(descriptor)
        } catch {
            print("è·å–äº¤æ˜“å¤±è´¥: \(error)")
            return []
        }
    }
    
    func saveTransaction(_ transaction: Transaction) async throws {
        modelContext.insert(transaction)
        try modelContext.save()
        
        // æ›´æ–°è´¦æˆ·ä½™é¢
        await updateAccountBalance(for: transaction)
    }
    
    // MARK: - Account Operations
    
    func fetchAccounts(for ledger: Ledger) async -> [Account] {
        let descriptor = FetchDescriptor<Account>(
            predicate: #Predicate { $0.ledger == ledger }
        )
        return (try? modelContext.fetch(descriptor)) ?? []
    }
    
    func calculateTotalAssets(for ledger: Ledger) async -> Decimal {
        let accounts = await fetchAccounts(for: ledger)
        return accounts
            .filter { !$0.excludeFromTotal }
            .reduce(0) { $0 + $1.balance }
    }
    
    // MARK: - Private Helpers
    
    private func updateAccountBalance(for transaction: Transaction) async {
        switch transaction.type {
        case .expense:
            transaction.fromAccount?.balance -= transaction.amount
        case .income:
            transaction.toAccount?.balance += transaction.amount
        case .transfer:
            transaction.fromAccount?.balance -= transaction.amount
            transaction.toAccount?.balance += transaction.amount
        case .adjustment:
            transaction.toAccount?.balance = transaction.amount
        }
        
        try? modelContext.save()
    }
}
```

---

## 5. ä¾èµ–ç®¡ç†

### 5.1 ç¬¬ä¸‰æ–¹ä¾èµ–

æœ¬é¡¹ç›®**ä¸ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹ä¾èµ–**ï¼Œ100%ä½¿ç”¨AppleåŸç”Ÿæ¡†æ¶ï¼š

| åŠŸèƒ½ | ä½¿ç”¨æ¡†æ¶ | è¯´æ˜ |
|-----|---------|------|
| UI | SwiftUI | å®˜æ–¹UIæ¡†æ¶ |
| æ•°æ® | SwiftData | å®˜æ–¹æ•°æ®æ¡†æ¶ |
| äº‘åŒæ­¥ | CloudKit | å®˜æ–¹äº‘æœåŠ¡ |
| å›¾è¡¨ | Swift Charts | å®˜æ–¹å›¾è¡¨æ¡†æ¶ |
| ç½‘ç»œ | URLSession | å®˜æ–¹ç½‘ç»œæ¡†æ¶ï¼ˆæ±‡ç‡ç­‰ï¼‰ |
| å¹¶å‘ | Swift Concurrency | åŸç”Ÿå¹¶å‘ |

**ä¼˜åŠ¿**ï¼š
- âœ… é›¶ä¾èµ–ï¼Œæ— ä¾›åº”é“¾é£é™©
- âœ… æ€§èƒ½æœ€ä¼˜
- âœ… åŒ…ä½“ç§¯æœ€å°
- âœ… é•¿æœŸç»´æŠ¤æ€§æœ€ä½³

### 5.2 ç³»ç»Ÿæ¡†æ¶å¼•ç”¨

```swift
// ä¸»è¦ä½¿ç”¨çš„ç³»ç»Ÿæ¡†æ¶
import SwiftUI           // UIæ¡†æ¶
import SwiftData         // æ•°æ®æŒä¹…åŒ–
import CloudKit          // äº‘åŒæ­¥
import Charts            // å›¾è¡¨
import WidgetKit         // Widget
import ActivityKit       // Live Activities
import UserNotifications // é€šçŸ¥
import StoreKit          // å†…è´­ï¼ˆProç‰ˆæœ¬ï¼‰
```

---

## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 å¯åŠ¨æ€§èƒ½

**ç›®æ ‡**: å†·å¯åŠ¨ < 1ç§’

**ç­–ç•¥**:
1. **å»¶è¿ŸåŠ è½½**: éé¦–é¡µæ¨¡å—æŒ‰éœ€åŠ è½½
2. **é¢„åŠ è½½å…³é”®æ•°æ®**: å¯åŠ¨æ—¶åªåŠ è½½30å¤©å†…æ•°æ®
3. **å¼‚æ­¥åˆå§‹åŒ–**: ä½¿ç”¨`Task`å¼‚æ­¥åˆå§‹åŒ–æœåŠ¡

```swift
// ç¤ºä¾‹ï¼šé¦–é¡µå»¶è¿ŸåŠ è½½
struct HomeView: View {
    @StateObject private var viewModel = HomeViewModel()
    
    var body: some View {
        ScrollView {
            NetAssetCard(amount: viewModel.totalAssets)
            
            // å»¶è¿ŸåŠ è½½éå…³é”®ç»„ä»¶
            LazyVStack {
                TransactionList(transactions: viewModel.transactions)
            }
        }
        .task {
            await viewModel.loadData()
        }
    }
}
```

### 6.2 åˆ—è¡¨æ€§èƒ½

**ç›®æ ‡**: 60fps/120fps æµç•…æ»šåŠ¨

**ç­–ç•¥**:
1. **LazyVStack**: å»¶è¿Ÿæ¸²æŸ“
2. **åˆ†é¡µåŠ è½½**: æ¯æ¬¡åŠ è½½50æ¡
3. **ç¼“å­˜è®¡ç®—ç»“æœ**: æ—¥æ±‡æ€»ã€æœˆæ±‡æ€»ç¼“å­˜

```swift
// ç¤ºä¾‹ï¼šé«˜æ€§èƒ½åˆ—è¡¨
struct TransactionList: View {
    let transactions: [Transaction]
    
    var body: some View {
        LazyVStack(spacing: 0, pinnedViews: [.sectionHeaders]) {
            ForEach(groupedTransactions, id: \.date) { group in
                Section {
                    ForEach(group.transactions) { transaction in
                        TransactionRow(transaction: transaction)
                            .id(transaction.id)
                    }
                } header: {
                    DateSectionHeader(date: group.date, total: group.total)
                }
            }
        }
    }
    
    // æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆç¼“å­˜ç»“æœï¼‰
    private var groupedTransactions: [TransactionGroup] {
        // ä½¿ç”¨@Stateç¼“å­˜è®¡ç®—ç»“æœ
    }
}
```

### 6.3 å†…å­˜ä¼˜åŒ–

**ç­–ç•¥**:
1. **åŠæ—¶é‡Šæ”¾**: ä½¿ç”¨`weak`/`unowned`é¿å…å¾ªç¯å¼•ç”¨
2. **å›¾ç‰‡å‹ç¼©**: å‘ç¥¨ç…§ç‰‡è‡ªåŠ¨å‹ç¼©
3. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨`ModelContext.processPendingChanges()`æ‰¹é‡ä¿å­˜

---

## 7. å®‰å…¨æ€§è®¾è®¡

### 7.1 æ•°æ®å®‰å…¨

| å®‰å…¨æªæ–½ | å®ç°æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| **æœ¬åœ°åŠ å¯†** | Data Protection API | iOSè‡ªåŠ¨åŠ å¯†è®¾å¤‡å­˜å‚¨ |
| **äº‘ç«¯åŠ å¯†** | CloudKitç«¯åˆ°ç«¯åŠ å¯† | å¼€å‘è€…æ— æ³•æŸ¥çœ‹ç”¨æˆ·æ•°æ® |
| **ä¼ è¾“åŠ å¯†** | HTTPS | æ‰€æœ‰ç½‘ç»œè¯·æ±‚ä½¿ç”¨TLS |
| **ç”Ÿç‰©è®¤è¯** | LocalAuthentication | Face ID/Touch IDä¿æŠ¤ï¼ˆå¯é€‰ï¼‰ |

```swift
// ç¤ºä¾‹ï¼šå¯ç”¨ç”Ÿç‰©è®¤è¯
import LocalAuthentication

class SecurityService {
    func enableBiometricAuth() async -> Bool {
        let context = LAContext()
        var error: NSError?
        
        guard context.canEvaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, error: &error) else {
            return false
        }
        
        do {
            let success = try await context.evaluatePolicy(
                .deviceOwnerAuthenticationWithBiometrics,
                localizedReason: "éªŒè¯èº«ä»½ä»¥æŸ¥çœ‹è´¦æœ¬"
            )
            return success
        } catch {
            return false
        }
    }
}
```

### 7.2 éšç§ä¿æŠ¤

**éµå¾ªåŸåˆ™**:
- âœ… æ•°æ®æœ€å°åŒ–ï¼šåªæ”¶é›†å¿…è¦æ•°æ®
- âœ… æœ¬åœ°ä¼˜å…ˆï¼šæ•°æ®ä¼˜å…ˆå­˜æœ¬åœ°
- âœ… ç”¨æˆ·æŒæ§ï¼šæ”¯æŒå¯¼å‡º/åˆ é™¤æ‰€æœ‰æ•°æ®
- âœ… é€æ˜åŒ–ï¼šæ¸…æ™°è¯´æ˜æ•°æ®ç”¨é€”

---

## 8. å¯æ‰©å±•æ€§è®¾è®¡

### 8.1 æ¨¡å—åŒ–è®¾è®¡

æ‰€æœ‰æ¨¡å—æ¾è€¦åˆï¼Œä¾¿äºï¼š
- æ·»åŠ æ–°è´¦æˆ·ç±»å‹ï¼ˆå¦‚è™šæ‹Ÿè´§å¸ï¼‰
- æ·»åŠ æ–°æŠ¥è¡¨ç±»å‹ï¼ˆå¦‚ç°é‡‘æµç€‘å¸ƒå›¾ï¼‰
- æ·»åŠ æ–°å¯¼å‡ºæ ¼å¼ï¼ˆå¦‚Excelï¼‰

### 8.2 æ’ä»¶åŒ–æ¶æ„ï¼ˆæœªæ¥ï¼‰

é¢„ç•™æ‰©å±•ç‚¹ï¼š
```swift
// ç¤ºä¾‹ï¼šå¯¼å‡ºå™¨åè®®
protocol Exporter {
    func export(transactions: [Transaction]) async throws -> Data
}

class CSVExporter: Exporter {
    func export(transactions: [Transaction]) async throws -> Data {
        // CSVå¯¼å‡ºå®ç°
    }
}

// æœªæ¥å¯æ·»åŠ ï¼š
// class ExcelExporter: Exporter { }
// class JSONExporter: Exporter { }
```

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 æµ‹è¯•é‡‘å­—å¡”

```
         /\
        /UI\         10% - UIæµ‹è¯•ï¼ˆå…³é”®æµç¨‹ï¼‰
       /____\
      /      \
     /é›†æˆæµ‹è¯•\       20% - é›†æˆæµ‹è¯•ï¼ˆç»„ä»¶åä½œï¼‰
    /__________\
   /            \
  /  å•å…ƒæµ‹è¯•    \    70% - å•å…ƒæµ‹è¯•ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
 /________________\
```

### 9.2 æµ‹è¯•è¦†ç›–ç›®æ ‡

| å±‚çº§ | è¦†ç›–ç‡ç›®æ ‡ | é‡ç‚¹æµ‹è¯•å†…å®¹ |
|-----|-----------|------------|
| Model | 100% | æ•°æ®æ¨¡å‹é€»è¾‘ |
| ViewModel | 90% | ä¸šåŠ¡é€»è¾‘ã€çŠ¶æ€ç®¡ç† |
| Service | 95% | è½¬è´¦ã€é€€æ¬¾ã€é¢„ç®—è®¡ç®— |
| View | å…³é”®æµç¨‹ | æ·»åŠ äº¤æ˜“ã€åˆ‡æ¢è´¦æœ¬ |

---

## 10. å¼€å‘å·¥å…·é“¾

### 10.1 å¿…éœ€å·¥å…·

| å·¥å…· | ç‰ˆæœ¬ | ç”¨é€” |
|-----|------|------|
| Xcode | 15.0+ | IDE |
| iOS Simulator | 17.0+ | æµ‹è¯• |
| SF Symbols | 5.0+ | å›¾æ ‡èµ„æº |
| Git | 2.x | ç‰ˆæœ¬æ§åˆ¶ |

### 10.2 æ¨èå·¥å…·

- **SwiftLint**: ä»£ç è§„èŒƒæ£€æŸ¥
- **SwiftFormat**: ä»£ç æ ¼å¼åŒ–
- **Instruments**: æ€§èƒ½åˆ†æ
- **TestFlight**: Betaæµ‹è¯•

---

## 11. æŠ€æœ¯é£é™©ä¸åº”å¯¹

| é£é™©ç‚¹ | é£é™©ç­‰çº§ | åº”å¯¹æªæ–½ |
|-------|---------|---------|
| SwiftDataæ–°æ¡†æ¶ä¸ç¨³å®š | ä¸­ | å……åˆ†æµ‹è¯•ï¼Œä¿ç•™CoreDataè¿ç§»æ–¹æ¡ˆ |
| CloudKitåŒæ­¥å†²çª | ä¸­ | å®ç°å®Œå–„çš„å†²çªè§£å†³ç­–ç•¥ |
| iOSç‰ˆæœ¬ç¢ç‰‡åŒ– | ä½ | æ˜ç¡®iOS 17+ï¼Œä¸å‘ä¸‹å…¼å®¹ |
| æ€§èƒ½ç“¶é¢ˆ | ä½ | é¢„åŠ è½½+ç¼“å­˜+åˆ†é¡µ |

---

## 12. æ¶æ„æ¼”è¿›è·¯çº¿

### ç¬¬ä¸€ç‰ˆ (v1.0)
- âœ… æ ¸å¿ƒMVVMæ¶æ„
- âœ… SwiftDataæœ¬åœ°å­˜å‚¨
- âœ… åŸºç¡€CloudKitåŒæ­¥

### ç¬¬äºŒç‰ˆ (v2.0)
- ğŸ”² å¤šè®¾å¤‡å®æ—¶åŒæ­¥ä¼˜åŒ–
- ğŸ”² Widgetäº¤äº’å¢å¼º
- ğŸ”² Siriå¿«æ·æŒ‡ä»¤

### ç¬¬ä¸‰ç‰ˆ (v3.0)
- ğŸ”² iPadé€‚é…
- ğŸ”² Apple Watchç‰ˆæœ¬
- ğŸ”² Mac Catalystç‰ˆæœ¬

---

## é™„å½•A: å…³é”®æŠ€æœ¯å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆé€‰æ‹©SwiftDataè€ŒéCoreDataï¼Ÿ

**å†³ç­–**: SwiftData
**æ—¥æœŸ**: 2026-01-24
**ç†ç”±**:
1. SwiftDataæ˜¯Appleæœªæ¥ä¸»æ¨æ–¹æ¡ˆ
2. ä»£ç é‡å‡å°‘50%
3. ä¸SwiftUIé›†æˆæ›´ç´§å¯†
4. è‡ªåŠ¨æ”¯æŒCloudKitåŒæ­¥
5. é¡¹ç›®ä¸ºæ–°å¼€å‘ï¼Œæ— å†å²åŒ…è¢±

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Firebaseï¼Ÿ

**å†³ç­–**: ä¸ä½¿ç”¨
**ç†ç”±**:
1. éšç§ä¼˜å…ˆï¼šCloudKitæ•°æ®ç«¯åˆ°ç«¯åŠ å¯†
2. æˆæœ¬ï¼šCloudKitå¯¹å¼€å‘è€…å…è´¹
3. åŸç”Ÿæ€§ï¼šCloudKitä¸iOSæ·±åº¦é›†æˆ
4. ä¿¡ä»»ï¼šç”¨æˆ·æ›´ä¿¡ä»»Apple

---

## é™„å½•B: å‚è€ƒèµ„æ–™

- [SwiftUIå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/swiftui/)
- [SwiftDataå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/swiftdata)
- [CloudKitå®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/cloudkit)
- [Swift Chartsæ–‡æ¡£](https://developer.apple.com/documentation/charts)
- [Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£éšæ¶æ„æ¼”è¿›æŒç»­æ›´æ–°
**æœ€åæ›´æ–°**: 2026-01-24
