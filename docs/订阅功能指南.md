# 订阅测试指南

## 问题说明

### 1. 会员时间计算问题

**现象：** 购买年度会员后，有效期显示到2026.2.1而不是2027.2.1

**原因：** 这是**正常的沙盒测试行为**，不是bug！

苹果沙盒测试环境会大幅加速订阅周期，便于开发者快速测试：

| 真实环境 | 沙盒环境 | 加速倍数 |
|---------|---------|---------|
| 1周订阅 | 3分钟 | 3,360倍 |
| 1月订阅 | 5分钟 | 8,640倍 |
| 2月订阅 | 10分钟 | 8,640倍 |
| 3月订阅 | 15分钟 | 8,640倍 |
| 6月订阅 | 30分钟 | 8,640倍 |
| **1年订阅** | **1小时** | **8,760倍** |

所以您看到的有效期到2026.2.1（1小时后）是完全正确的沙盒测试行为。

**验证：** 
- 在沙盒环境购买年订阅后，等待1小时，订阅会自动过期
- 如果开启了自动续订，1小时后会自动续订（沙盒环境最多续订6次）

### 2. 代码验证

订阅过期时间的计算完全依赖 StoreKit 2 的 `transaction.expirationDate`，代码本身没有问题：

```swift
// SubscriptionManager.swift 第315-321行
case SubscriptionProducts.monthlyID, SubscriptionProducts.yearlyID:
    // 订阅 - 检查过期时间
    if let expirationDate = transaction.expirationDate {
        if subscriptionExpiry == nil || expirationDate > subscriptionExpiry! {
            subscriptionExpiry = expirationDate
        }
    }
```

## 如何重置订阅进行测试

### 方法1：使用App内置的调试工具（推荐）

在DEBUG模式下，订阅页面底部会显示调试工具区域：

1. **打开订阅页面**
   - 设置 → 顶部订阅状态卡片
   - 或任何需要会员功能的地方

2. **查看调试信息**
   - 当前状态和过期时间
   - 剩余有效时间（实时倒计时）
   - 环境说明（沙盒测试）

3. **可用操作**
   - **打印订阅详情到控制台**：查看所有订阅交易的详细信息
   - **清除本地订阅缓存**：清除本地缓存，但不删除App Store购买记录

### 方法2：在设备上管理沙盒订阅

#### iOS 15及以上版本

1. **打开设备设置**
2. **进入 App Store**
3. **点击"沙盒账户"**
4. **点击你的测试账号**
5. **点击"管理"**
6. **查看并管理订阅**
   - 取消自动续订
   - 删除订阅记录

#### 完全重置测试账号

如果需要完全清空测试账号的购买记录：

1. 在设备设置中退出当前沙盒测试账号
2. 重新登录或使用新的沙盒测试账号
3. App会重新检测订阅状态

### 方法3：使用 Xcode 控制台

运行App时，在Xcode控制台查看订阅状态日志：

```bash
# 查看订阅更新
# 搜索包含 "Subscription" 的日志输出

# 清除本地缓存后会看到：
✅ 已清除本地订阅缓存
```

### 方法4：删除并重装App

⚠️ 注意：这会清除所有本地数据！

1. 删除App（包括所有数据）
2. 在设备设置中管理沙盒订阅（参考方法2）
3. 重新从Xcode安装App

## 测试场景

### 场景1：测试购买流程

1. 确保App处于免费状态
2. 尝试使用付费功能，应该被拦截
3. 点击升级，选择订阅方案
4. 完成购买（沙盒环境不收费）
5. 验证功能解锁

### 场景2：测试订阅过期

1. 购买年订阅（沙盒环境1小时过期）
2. 验证功能立即解锁
3. 等待1小时后
4. App应该检测到订阅过期，功能重新锁定

### 场景3：测试自动续订

1. 购买年订阅
2. 确保开启自动续订
3. 等待1小时过期后
4. 沙盒环境会自动续订（最多6次）
5. 验证订阅仍然有效

### 场景4：测试恢复购买

1. 在一个设备购买订阅
2. 删除App或清除本地缓存
3. 重新安装或启动App
4. 点击"恢复购买"
5. 验证订阅状态恢复

### 场景5：测试买断产品

1. 购买买断产品（lifetime）
2. 验证没有过期时间
3. 删除App重装
4. 恢复购买应该永久有效

## 沙盒测试账号管理

### 创建沙盒测试账号

1. 访问 [App Store Connect](https://appstoreconnect.apple.com)
2. 用户和访问 → 沙盒技术测试员
3. 点击"+"创建新的测试账号
4. 填写邮箱、密码等信息（可以使用虚拟邮箱）

### 使用测试账号

1. **不要在设置 → Apple ID 中登录测试账号**
2. 只在App内购买时才登录沙盒账号
3. 首次购买时会弹出登录框，输入沙盒测试账号

### 测试账号注意事项

- ✅ 可以在多个设备使用同一个测试账号
- ✅ 可以免费测试所有购买和订阅
- ✅ 订阅周期大幅加速，便于快速测试
- ❌ 不要用真实Apple ID在沙盒环境测试
- ❌ 沙盒购买记录不会同步到真实环境

## 常见问题

### Q1: 为什么点击购买后没有反应？

**可能原因：**
1. 没有登录沙盒测试账号
2. 网络连接问题
3. App Store服务暂时不可用

**解决方案：**
1. 确保已创建沙盒测试账号
2. 检查网络连接
3. 查看Xcode控制台错误信息

### Q2: 已经购买了但功能还是锁定

**可能原因：**
1. StoreKit交易未完成
2. 本地缓存未更新

**解决方案：**
1. 点击"恢复购买"
2. 重启App
3. 使用调试工具查看订阅状态
4. 查看Xcode控制台日志

### Q3: 订阅过期了但App还显示高级版

**可能原因：**
1. 本地缓存未更新
2. 正在自动续订中

**解决方案：**
1. 杀死App重新启动
2. 使用调试工具清除本地缓存
3. 点击"恢复购买"刷新状态

### Q4: 如何测试多个不同的订阅？

**方案：**
1. 购买第一个订阅（如月订阅）
2. 在设备设置中取消该订阅
3. 购买另一个订阅（如年订阅）
4. StoreKit会自动处理升级/降级

### Q5: 测试完成后如何清理？

**步骤：**
1. 在设备设置中管理沙盒订阅，全部取消
2. 使用App内调试工具清除本地缓存
3. 可选：退出沙盒测试账号

## 生产环境注意事项

### 上架前检查清单

- [ ] 在 App Store Connect 中配置真实的订阅产品
- [ ] 产品ID与代码中的ID完全一致
- [ ] 设置正确的订阅周期（真实环境不会加速）
- [ ] 配置订阅的本地化信息
- [ ] 设置订阅的自动续订价格
- [ ] 关闭DEBUG模式的调试工具
- [ ] 测试恢复购买功能
- [ ] 准备订阅条款和隐私政策

### 真实环境差异

| 特性 | 沙盒环境 | 真实环境 |
|-----|---------|---------|
| 订阅周期 | 加速（1年=1小时） | 真实周期 |
| 自动续订次数 | 最多6次 | 无限制 |
| 扣款 | 不扣款 | 真实扣款 |
| 测试账号 | 专用沙盒账号 | 真实Apple ID |
| 购买记录 | 仅沙盒可见 | App Store可见 |

### 监控建议

上架后应该监控：
1. 订阅转化率
2. 续订率
3. 退款率
4. 各订阅方案的选择比例
5. 用户反馈

## 调试技巧

### 1. 查看详细日志

在DEBUG模式使用调试工具"打印订阅详情到控制台"，会输出：
- 当前订阅状态
- 所有交易记录
- 产品ID和过期时间
- 可用产品列表

### 2. 实时监控过期时间

调试工具会显示订阅剩余时间的实时倒计时，方便观察沙盒环境的1小时过期

### 3. 模拟不同状态

- 免费用户：清除订阅缓存
- 订阅用户：购买月/年订阅
- 买断用户：购买lifetime产品
- 过期用户：等待沙盒订阅过期

### 4. 网络抓包

如果需要调试StoreKit通信问题，可以使用Charles或Proxyman抓包

## 参考资料

- [StoreKit 2 官方文档](https://developer.apple.com/documentation/storekit)
- [Testing In-App Purchases](https://developer.apple.com/documentation/storekit/in-app_purchase/testing_in-app_purchases)
- [Sandbox Testing](https://developer.apple.com/help/app-store-connect/test-in-app-purchases/test-in-app-purchases-in-sandbox)

## 更新日志

- 2026-01-31: 初始版本，添加沙盒测试说明和调试工具
